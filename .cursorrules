# Pine Script Conversion Rules

You are working on converting a complex `Pine Script` strategy to `Python`. Follow these rules strictly to ensure high-quality, spec-driven development.

## 1. Spec-Driven Workflow

- **Spec First**: Always verify logic against `research.md`. If the spec is unclear, pause and clarify or update `research.md`.
- **Logic Mapping**: Every Python function implementing trading logic should reference the specific Pine Script "Case" or Line Number it replicates.
  - Example: `def check_case_2(self): # Corresponds to line 475 in source`

## 2. Python Coding Standards

- **Typing**: All function signatures MUST have type hints.
- **Docstrings**: Use Google-style docstrings for all classes and methods.
- **Immutability**: Prefer immutable data structures (`dataclasses(frozen=True)`) for "Events" or "Signals".
- **State Encapsulation**: Do not use global variables. All state (zones, counters) must be encapsulated within the `Strategy` class.

## 3. Financial Logic

- **Precision**: Use `float` for price calculations but be mindful of floating-point errors (consider `decimal` if extreme precision is needed, though `float` is standard for backtesting).
- **Lookahead Bias**: When using higher timeframe data (M15) on lower timeframe simulation (M1), ensure you are NOT peaking ahead. Ensure timestamps align correctly (M15 data is only available after the candle _closes_).

## 4. Dependencies

- Use `pandas` and `pandas_ta` for data processing.
- Use native Python structures (`deque`, `list`) for high-frequency loop logic to avoid Pandas overhead in the inner loop if not vectorized.

## 5. Backtest Execution & Testing

- **Manual Testing Required**: DO NOT automatically run backtest commands. When strategy changes are made, instruct the user to run backtest manually for verification.
- **Available Commands**:

  ```bash
  # Backtest specific year (2020-2025)
  python main.py --year 2022
  python main.py --year 2024

  # Backtest all available data (default file)
  python main.py
  ```

- **Output Locations**:
  - Logs: `output/backtest_YYYYMMDD_HHMMSS_yearYYYY.log`
  - Charts: `output/backtest_visualization_*.png`
- **Timezone Convention**:
  - Data source: Dukascopy CSV (Unix milliseconds, UTC timezone)
  - Trading sessions: Bangkok time (UTC+7)
  - Log display: Bangkok time with (+07) suffix
- **When to Suggest Manual Testing**:
  - After implementing entry/exit logic changes
  - After modifying ADX, zone detection, or filter parameters
  - When user asks to verify behavior
  - After fixing bugs in strategy logic
- **Testing Specific Periods**: For monthly analysis, guide user to grep logs:
  ```powershell
  # Example: Analyze May 2022 trades
  Select-String -Path "output\backtest_*_year2022.log" -Pattern "2022-05" | Select-Object -First 50
  ```
